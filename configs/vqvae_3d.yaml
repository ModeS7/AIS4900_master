# 3D VQ-VAE Training Configuration
#
# Trains 3D VQ-VAE for volumetric latent diffusion.
# Uses discrete codebook instead of KL regularization.
# Lower memory than KL-VAE (no mu/logvar branches).
#
# Usage:
#   python -m medgen.scripts.train_vqvae_3d
#   python -m medgen.scripts.train_vqvae_3d paths=cluster mode=multi_modality

defaults:
  - paths: local
  - model: default
  - mode: dual
  - vqvae_3d: default
  - training: default
  - _self_

# Pretrained checkpoint (for fine-tuning)
pretrained_checkpoint: null

# ============================================================================
# 3D Volume Configuration
# ============================================================================
volume:
  depth: 160                      # Pad 150 -> 160 for clean 4x compression
  height: 256
  width: 256
  pad_depth_to: 160
  pad_mode: replicate
  slice_step: 1                   # 1=all slices

# ============================================================================
# Training Overrides for 3D
# ============================================================================
training:
  epochs: 125
  batch_size: 1                   # Small batch for 3D (memory)
  learning_rate: 5.0e-5           # Lower LR for 3D
  gradient_clip_norm: 1.0
  warmup_epochs: 5
  val_interval: 10
  use_ema: false                  # EMA doubles memory
  augment_type: vae_3d
  use_compile: false              # Disabled for 3D (memory)
  gradient_checkpointing: true    # Saves ~50% memory
  logging:
    grad_norm: true
    regional_losses: true           # Tumor/background loss tracking
    msssim: true                    # 3D MS-SSIM (native via MONAI)
    psnr: true
    lpips: true                     # Slice-by-slice LPIPS
    flops: true                     # FLOPs per epoch tracking

hydra:
  run:
    dir: ${paths.model_dir}/compression_3d/${mode.name}/${oc.select:training.name,""}${volume.height}x${volume.depth}_${now:%Y%m%d-%H%M%S}
  sweep:
    dir: ${paths.model_dir}/compression_3d/multirun/${now:%Y%m%d-%H%M%S}
    subdir: ${hydra.job.num}
