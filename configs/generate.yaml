# Generation Configuration
#
# Generate synthetic medical images/volumes using trained diffusion models.
#
# Usage:
#   # 2D: seg -> bravo pipeline (local)
#   python -m medgen.scripts.generate mode=bravo \
#       seg_model=runs/seg/model.pt image_model=runs/bravo/model.pt
#
#   # 3D: size_bins -> seg -> bravo pipeline (cluster)
#   python -m medgen.scripts.generate paths=cluster spatial_dims=3 mode=bravo \
#       seg_model=runs/seg/checkpoint.pt image_model=runs/bravo/checkpoint.pt
#
#   # Generate only seg masks (3D)
#   python -m medgen.scripts.generate spatial_dims=3 mode=seg_conditioned \
#       seg_model=runs/seg_conditioned/checkpoint.pt

defaults:
  - paths: local
  - _self_

# Core settings
spatial_dims: 2           # 2 for images, 3 for volumes
strategy: rflow           # ddpm or rflow
gen_mode: bravo           # bravo, dual, seg_conditioned

# Model paths (relative to working dir or absolute)
seg_model: null           # Path to trained segmentation model
image_model: null         # Path to trained image model (bravo or dual)

# Dimensions
image_size: 128           # Image height/width
depth: 160                # Volume depth for 3D (generation depth)
trim_slices: 10           # Trim last N slices from 3D output (training pads 10, so remove them)

# Field of view in mm (used to compute voxel spacing)
# Voxel spacing = fov_mm / image_size (e.g., 240/128 = 1.875mm)
fov_mm: 240.0

# Generation settings
batch_size: 8             # Batch size (auto-reduced for 3D)
num_images: 1000          # Number of samples to generate
num_steps: 50             # Number of diffusion steps
current_image: 0          # Starting counter for resuming

# Size bin settings (for seg_conditioned or 3D seg generation)
size_bins: null           # Fixed size bins as comma-separated ints, e.g., "0,0,1,0,0,0,1"
min_tumors: 1             # Minimum tumors when random sampling
max_tumors: 5             # Maximum tumors when random sampling

# Classifier-free guidance scales (1.0 = no guidance, >1.0 = stronger conditioning)
cfg_scale_seg: 1.0        # CFG for seg generation (size bin conditioning)
cfg_scale_bravo: 1.0      # CFG for bravo generation (seg mask conditioning)

# Dynamic CFG: linearly interpolate from cfg_scale (at t=T) to cfg_scale_end (at t=0)
# Set to null to use constant CFG, or set to 1.0 for "high CFG early, no CFG late"
cfg_scale_seg_end: null   # Ending CFG for seg (null = constant)
cfg_scale_bravo_end: null # Ending CFG for bravo (null = constant)

# ODE solver for generation (requires torchdiffeq for non-euler solvers)
# Options: euler (default), midpoint, rk4, dopri5
ode_solver: euler
ode_atol: 1e-5                    # Absolute tolerance (dopri5 only)
ode_rtol: 1e-5                    # Relative tolerance (dopri5 only)

# Seg mask validation (3D: per-slice check, same threshold as 2D)
max_white_percentage: 0.04   # Max tumor percentage per slice (4%)
max_retries: 10              # Max retries for invalid seg masks

# Validation settings (seg_conditioned)
validate_size_bins: true         # Validate generated tumors match requested size bins
validate_brain_mask: true        # Validate tumors are inside brain mask (3D)
brain_threshold: 0.05            # Brain mask intensity threshold
brain_tolerance: 0.0             # Tolerance for tumor-outside-brain overlap
brain_dilate_pixels: 0           # Dilate brain mask by N pixels before validation
max_brain_retries: 5             # Max retries for brain mask validation

# Size bin parameters (used when size_bins is null for random sampling)
bin_edges: [0, 3, 6, 10, 15, 20, 30]  # Feret diameter bin edges (mm)
num_bins: 7                             # Number of size bins
max_count: 10                           # Max tumor count per bin (for normalization)

# Output settings
output_subdir: ""         # Subdirectory under generated_dir (e.g., "3d_full_pipeline")
verbose: true             # Enable progress bars (false for cluster)

# Hydra configuration
hydra:
  run:
    dir: .                # Don't create Hydra output dirs for generation
  output_subdir: null     # Disable .hydra subdirectory
