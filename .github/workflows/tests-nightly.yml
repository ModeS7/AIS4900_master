name: Nightly Tests

# Runs nightly on self-hosted runner at 3 AM UTC.
# GPU-dependent jobs (e2e, slow integration, baseline) remain disabled
# until a self-hosted GPU runner is configured with labels [self-hosted, gpu].

on:
  schedule:
    - cron: "0 3 * * *"  # 3 AM UTC daily
  workflow_dispatch:

env:
  VENV: /home/mode/actions-venv/bin/activate

jobs:
  # ==========================================================================
  # GPU-DEPENDENT JOBS (DISABLED - requires self-hosted GPU runner)
  # ==========================================================================
  # To enable these jobs:
  # 1. Set up a self-hosted runner with GPU
  # 2. Add labels: self-hosted, gpu
  # 3. Uncomment the jobs below
  # ==========================================================================

  # # E2E tests require GPU and golden checkpoints
  # e2e-tests:
  #   runs-on: [self-hosted, gpu]
  #   timeout-minutes: 120
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         lfs: true
  #     - name: Set up Python 3.11
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.11"
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -e .
  #         pip install -r requirements.txt
  #         pip install pytest pytest-timeout nibabel
  #     - name: Check for golden checkpoints
  #       id: check_checkpoints
  #       run: |
  #         if [ -d "tests/fixtures/golden_checkpoint/bravo" ]; then
  #           echo "checkpoints_exist=true" >> $GITHUB_OUTPUT
  #         else
  #           echo "checkpoints_exist=false" >> $GITHUB_OUTPUT
  #           echo "Golden checkpoints not found. Run: ./tests/fixtures/create_golden_checkpoint.sh"
  #         fi
  #     - name: Create golden checkpoints (if missing)
  #       if: steps.check_checkpoints.outputs.checkpoints_exist == 'false'
  #       run: ./tests/fixtures/create_golden_checkpoint.sh
  #       continue-on-error: true
  #     - name: Run E2E tests
  #       run: pytest tests/e2e -v --tb=short --timeout=600 -m "e2e"
  #     - name: Upload test artifacts
  #       if: failure()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: e2e-test-artifacts
  #         path: tests/fixtures/golden_checkpoint/**/checkpoint*.pt
  #         retention-days: 7

  # # Slow integration tests
  # slow-integration-tests:
  #   runs-on: [self-hosted, gpu]
  #   timeout-minutes: 60
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up Python 3.11
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.11"
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -e .
  #         pip install -r requirements.txt
  #         pip install pytest pytest-timeout
  #     - name: Run slow integration tests
  #       run: pytest tests/integration -m "slow" -v --tb=short --timeout=300

  # # Baseline regression tests (compare against saved baselines)
  # baseline-tests:
  #   runs-on: [self-hosted, gpu]
  #   timeout-minutes: 60
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Set up Python 3.11
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.11"
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install -e .
  #         pip install -r requirements.txt
  #         pip install pytest pytest-timeout
  #     - name: Run baseline tests
  #       run: pytest tests/integration -m "baseline" -v --tb=short --timeout=300
  #       continue-on-error: true
  #     - name: Upload baseline diffs
  #       if: failure()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: baseline-diffs
  #         path: tests/integration/baselines/
  #         retention-days: 7

  # ==========================================================================
  # CPU-ONLY JOBS (ACTIVE)
  # ==========================================================================

  # CPU-only comprehensive test
  comprehensive-cpu:
    runs-on: self-hosted
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: Install package in editable mode
        run: |
          source $VENV
          pip install -e .

      - name: Run all non-GPU tests
        run: |
          source $VENV
          pytest tests/ -m "not gpu and not baseline" \
            -v --tb=short --timeout=120 \
            --cov=src/medgen \
            --cov-report=term-missing

  # Notify on failure
  notify-failure:
    needs: [comprehensive-cpu]
    if: failure()
    runs-on: self-hosted

    steps:
      - name: Log failure
        run: |
          echo "Nightly test failure at $(date)"
          echo "Comprehensive CPU: ${{ needs.comprehensive-cpu.result }}"
